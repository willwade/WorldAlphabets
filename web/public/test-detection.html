<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Language Detection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        textarea { width: 100%; height: 100px; margin: 1rem 0; }
        button { padding: 0.5rem 1rem; margin: 0.5rem; }
        .result { margin: 1rem 0; padding: 1rem; background: #f5f5f5; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Language Detection Test</h1>
    <textarea id="testText" placeholder="Enter text to detect...">Die man het die boek gelees en hy is baie gelukkig.</textarea>
    <br>
    <button onclick="testDetection()">Detect Language</button>
    <div id="results"></div>

    <script type="module">
        // Simplified detection service for testing
        class SimpleDetectionService {
            constructor() {
                this.frequencyCache = new Map();
                this.availableLanguages = ['af', 'de', 'en', 'fr', 'es', 'it', 'pt', 'ru', 'ar', 'ko'];
            }

            tokenizeWords(text) {
                const normalized = text.normalize('NFKC').toLowerCase();
                const matches = normalized.match(/\p{L}+/gu) || [];
                return new Set(matches);
            }

            async loadFrequencyData(languageCode) {
                if (this.frequencyCache.has(languageCode)) {
                    return this.frequencyCache.get(languageCode);
                }

                try {
                    const response = await fetch(`./data/freq/top200/${languageCode}.txt`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const text = await response.text();
                    const lines = text.split(/\r?\n/).filter(line => line.trim());
                    
                    let mode = 'word';
                    let startIndex = 0;
                    
                    if (lines[0] && lines[0].startsWith('#')) {
                        const header = lines[0];
                        if (header.includes('bigram')) {
                            mode = 'bigram';
                        }
                        startIndex = 1;
                    }
                    
                    const ranks = new Map();
                    for (let i = startIndex; i < lines.length; i++) {
                        const token = lines[i].trim();
                        if (token && !ranks.has(token)) {
                            ranks.set(token, i - startIndex + 1);
                        }
                    }
                    
                    const data = { mode, ranks };
                    this.frequencyCache.set(languageCode, data);
                    return data;
                } catch (error) {
                    console.warn(`Failed to load frequency data for ${languageCode}:`, error);
                    const emptyData = { mode: 'word', ranks: new Map() };
                    this.frequencyCache.set(languageCode, emptyData);
                    return emptyData;
                }
            }

            calculateOverlap(tokens, ranks) {
                let score = 0;
                for (const token of tokens) {
                    const rank = ranks.get(token);
                    if (rank) {
                        score += 1 / Math.log2(rank + 1.5);
                    }
                }
                return score;
            }

            async detectLanguages(text) {
                const tokens = this.tokenizeWords(text);
                const results = [];
                
                console.log('Input text:', text);
                console.log('Tokens:', Array.from(tokens));
                
                for (const languageCode of this.availableLanguages) {
                    try {
                        const frequencyData = await this.loadFrequencyData(languageCode);
                        
                        let overlap = 0;
                        if (frequencyData.ranks.size > 0 && tokens.size > 0) {
                            overlap = this.calculateOverlap(tokens, frequencyData.ranks);
                            overlap /= Math.sqrt(tokens.size + 3);
                        }
                        
                        const finalScore = 0.35 * overlap; // Only frequency weight, no priors
                        
                        console.log(`${languageCode}: overlap=${overlap.toFixed(3)}, score=${finalScore.toFixed(3)}, freq_size=${frequencyData.ranks.size}`);
                        
                        if (finalScore > 0.01) { // Lower threshold for testing
                            results.push({
                                language: languageCode,
                                confidence: finalScore,
                                overlap: overlap,
                                tokenCount: tokens.size,
                                freqDataSize: frequencyData.ranks.size
                            });
                        }
                    } catch (error) {
                        console.warn(`Error processing language ${languageCode}:`, error);
                    }
                }
                
                results.sort((a, b) => b.confidence - a.confidence);
                return results.slice(0, 5);
            }
        }

        const detectionService = new SimpleDetectionService();

        window.testDetection = async function() {
            const text = document.getElementById('testText').value;
            const resultsDiv = document.getElementById('results');
            
            if (!text.trim()) {
                resultsDiv.innerHTML = '<div class="result">Please enter some text to detect.</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="result">Detecting languages...</div>';
            
            try {
                const results = await detectionService.detectLanguages(text.trim());
                
                let html = '<div class="result"><h2>Detection Results:</h2>';
                if (results.length > 0) {
                    html += '<ol>';
                    results.forEach(result => {
                        html += `<li><strong>${result.language}</strong>: ${(result.confidence * 100).toFixed(2)}% confidence 
                                (overlap: ${result.overlap.toFixed(3)}, tokens: ${result.tokenCount}, freq data: ${result.freqDataSize})</li>`;
                    });
                    html += '</ol>';
                } else {
                    html += '<p>No languages detected with sufficient confidence.</p>';
                }
                html += '</div>';
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Detection failed:', error);
                resultsDiv.innerHTML = `<div class="result">Error: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>
